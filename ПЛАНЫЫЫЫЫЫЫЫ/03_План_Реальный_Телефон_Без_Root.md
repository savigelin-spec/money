---
name: Система подтверждения возраста КСО - Реальный телефон без Root
overview: Реализация системы на реальном Android устройстве БЕЗ root прав. Биометрию подтверждает человек вручную, остальное автоматизировано.
device: Реальный Android телефон (любой)
root: Не требуется
---

# План реализации для реального телефона БЕЗ Root

Этот план описывает реализацию на реальном Android устройстве без root прав. Биометрию подтверждает человек вручную.

## Преимущества:

- Не нужно root права (безопаснее)
- Не нужно взламывать систему
- Работает на любом Android устройстве
- Легче настроить и поддерживать

## Ограничения:

- **Человек должен приложить палец** для подтверждения биометрии
- Не полностью автоматизировано (требуется участие человека)
- Но всё остальное работает автоматически

## Отличия от плана с Root:

### 1. Камера:
- Показываем QR код на экране компьютера/планшета
- Телефон физически сканирует QR код с экрана
- Аналогично плану с root

### 2. ADB подключение:
- Подключение через USB: `adb devices`
- Или через WiFi ADB: `adb connect <IP>:5555`
- Требуется включить USB отладку
- **НЕ требуется root доступ**

### 3. Биометрия БЕЗ Root:

**Процесс:**
1. Макс сканирует QR код через камеру
2. Макс показывает диалог "Приложите палец"
3. **ЧЕЛОВЕК прикладывает палец к сканеру** (один раз)
4. Макс генерирует QR код
5. Наш скрипт делает скриншот и извлекает QR

**Автоматизация:**
- Мы автоматизируем всё ДО и ПОСЛЕ биометрии
- В момент биометрии - пауза, ждём подтверждения человеком
- Определяем успешное подтверждение по изменению экрана (появление QR)

## Структура проекта:

```
money/
├── bot/                    # Telegram бот
├── server/                 # FastAPI сервер
├── macro/                  # Макросы и автоматизация
│   ├── qr_display.py      # Отображение QR на экране
│   ├── biometric_wait.py  # Ожидание ручного подтверждения биометрии
│   └── qr_scanner.py       # Сканирование QR через реальную камеру
└── config/                 # Конфигурация
```

## Модуль ожидания биометрии:

**`macro/biometric_wait.py`:**

```python
def wait_for_manual_biometric():
    """
    Ожидает, пока человек приложит палец.
    Определяет успешное подтверждение по изменению экрана.
    """
    # Делаем скриншот диалога биометрии
    screenshot_before = take_screenshot()
    
    # Ждём изменения экрана (таймаут 60 секунд)
    for i in range(30):  # 30 попыток по 2 секунды
        time.sleep(2)
        screenshot_after = take_screenshot()
        
        # Проверяем, изменился ли экран (диалог закрылся)
        if screenshots_different(screenshot_before, screenshot_after):
            # Проверяем, появился ли QR код на экране
            if has_qr_code(screenshot_after):
                return True  # Успешно!
    
    return False  # Таймаут
```

## Поток работы:

```
1. Пользователь отправляет QR КСО в бот
   ↓
2. Бот отправляет QR на сервер
   ↓
3. Сервер генерирует "чистый" QR код
   ↓
4. Отображаем QR код на экране компьютера (большое окно)
   ↓
5. ADB открывает приложение Макс на телефоне
   ↓
6. Макс сканирует QR код с экрана (через реальную камеру)
   ↓
7. Макс показывает диалог "Приложите палец"
   ↓
8. ⏸️ ПАУЗА - ждём, пока человек приложит палец
   ↓
9. Макс генерирует QR код (после подтверждения биометрии)
   ↓
10. ADB делает скриншот экрана телефона
   ↓
11. Извлекаем QR код из скриншота
   ↓
12. Генерируем чистый QR код
   ↓
13. Бот отправляет QR пользователю
```

## Преимущества этого подхода:

- ✅ Работает на любом Android устройстве
- ✅ Не требует root прав
- ✅ Безопасно (не взламываем систему)
- ✅ Легко настроить
- ✅ Почти полностью автоматизировано (только палец вручную)

## Недостатки:

- ❌ Требуется участие человека (приложить палец)
- ❌ Не полностью автоматизировано
- ❌ Медленнее, чем с root (нужно ждать человека)

## Когда использовать:

- Если нет возможности получить root
- Если важна безопасность устройства
- Если можно позволить человеку приложить палец один раз
- Для тестирования перед переходом на root версию

## Полный план смотри в основном файле PLAN.md
