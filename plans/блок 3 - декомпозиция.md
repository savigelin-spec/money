# Декомпозиция блока 3: Логика пользователей и модераторов

## Что реализовано

### 1. FSM состояния (`handlers/states.py`)

- **UserStates**:
  - `waiting_for_screenshot` — ожидание скриншота от пользователя
  - `waiting_for_payment_amount` — ожидание суммы пополнения баланса

- **ModeratorStates**:
  - `moderating_session` — активная сессия модерации
  - `waiting_for_moderator_photo` — ожидание фото от модератора

### 2. Клавиатуры для пользователей (`keyboards/user_keyboards.py`)

- `get_main_menu_keyboard()` — главное меню с кнопками:
  - Подать заявку на подтверждение (250₽)
  - Мой баланс
  - Пополнить баланс
  - Мои заявки

- `get_back_to_menu_keyboard()` — кнопка возврата в главное меню

- `get_application_status_keyboard(application_id)` — клавиатура для просмотра статуса заявки с кнопкой обновления

- `get_applications_list_keyboard(applications)` — список заявок пользователя с возможностью просмотра каждой

### 3. Клавиатуры для модераторов (`keyboards/moderator_keyboards.py`)

- `get_moderator_panel_keyboard()` — панель модератора:
  - Доступные заявки
  - Мои активные сессии
  - Статистика

- `get_pending_applications_keyboard(applications)` — список ожидающих заявок с позицией в очереди

- `get_moderation_session_keyboard(session_id)` — клавиатура для активной сессии:
  - Подтвердить / Отклонить
  - Кнопка отправки фото (если еще не отправлено)

- `get_active_sessions_keyboard(sessions)` — список активных сессий модератора

### 4. Handlers для пользователей (`handlers/user_handlers.py`)

- `/start` — регистрация/получение пользователя, показ главного меню

- `callback_main_menu` — возврат в главное меню

- `callback_create_application` — создание заявки:
  - Проверка баланса и активных заявок
  - Списание 250₽
  - Создание заявки в очереди
  - Расчет позиции и времени ожидания
  - Уведомление о создании

- `callback_show_balance` — показ баланса пользователя

- `callback_deposit_balance` — начало процесса пополнения (перевод в состояние `waiting_for_payment_amount`)

- `process_payment_amount` — обработка суммы пополнения (валидация, создание транзакции)

- `callback_my_applications` — список всех заявок пользователя

- `callback_view_application` — просмотр конкретной заявки с деталями

- `callback_refresh_application` — обновление статуса заявки в очереди

- `process_user_screenshot` — обработка скриншота от пользователя:
  - Сохранение file_id в сессии
  - Отправка скриншота модератору
  - Уведомление пользователя

### 5. Handlers для модераторов (`handlers/moderator_handlers.py`)

- `/moderator` — команда доступа к панели модератора (проверка роли)

- `callback_moderator_panel` — показ панели модератора

- `callback_moderator_pending_applications` — список ожидающих заявок

- `callback_moderator_take_application` — модератор берет заявку:
  - Назначение модератора на заявку
  - Создание сессии модерации
  - Обновление позиций в очереди
  - Уведомление пользователя о подключении модератора

- `callback_moderator_active_sessions` — список активных сессий модератора

- `callback_moderator_session` — просмотр деталей сессии модерации

- `callback_moderator_send_photo` — переход в состояние отправки фото

- `process_moderator_photo` — обработка фото от модератора:
  - Сохранение file_id в сессии
  - Отправка фото пользователю

- `callback_moderator_approve` — подтверждение заявки:
  - Завершение сессии
  - Обновление статистики модератора
  - Уведомление пользователя

- `callback_moderator_reject` — отклонение заявки:
  - Завершение сессии
  - Обновление статистики модератора
  - Уведомление пользователя

- `callback_moderator_stats` — статистика модератора (всего сессий, среднее время)

### 6. Утилиты очереди (`utils/queue.py`)

- `calculate_queue_position()` — расчет позиции заявки в очереди

- `calculate_estimated_wait_time()` — расчет времени ожидания на основе позиции и среднего времени сессии

- `update_queue_positions()` — обновление позиций всех pending заявок при изменении очереди

- `format_wait_time()` — форматирование времени ожидания в читаемый вид

### 7. Дополнительные функции в `database/queries.py`

- `get_user_applications()` — получение всех заявок пользователя

- `get_application_by_id()` — получение заявки по ID

- `get_active_moderation_sessions_by_moderator()` — активные сессии модератора

- `get_moderation_session_by_id()` — получение сессии по ID

- `get_active_moderation_session_by_user()` — активная сессия пользователя

### 8. Интеграция в `bot.py`

- Инициализация БД при старте (`init_db()`)

- Регистрация всех routers:
  - `user_handlers.router`
  - `moderator_handlers.router`

## Безопасность

- Проверка ролей перед доступом к функциям модератора (`is_moderator()`)

- Валидация ввода суммы пополнения (регулярное выражение, минимальная сумма)

- Защита от повторного создания заявки при активной сессии (`can_create_application()`)

- Проверка прав доступа при просмотре заявок (только свои заявки для пользователей)

## Потоки взаимодействия

1. **Создание заявки пользователем**:
   - Проверка баланса → Списание → Создание заявки → Расчет очереди → Уведомление

2. **Модератор берет заявку**:
   - Выбор заявки → Назначение модератора → Создание сессии → Уведомление пользователя

3. **Обмен фотографиями**:
   - Пользователь отправляет скриншот → Сохранение → Отправка модератору
   - Модератор отправляет фото → Сохранение → Отправка пользователю

4. **Завершение сессии**:
   - Модератор подтверждает/отклоняет → Завершение сессии → Обновление статистики → Уведомление пользователя

## Связь с другими блоками

- Использует модели и функции из **блока 2** (БД)
- Использует логику очереди из **блока 4** (через `utils/queue.py`)
- Использует систему баланса из **блока 4** (через `database/queries.py`)
