# Блок 6.6: Оптимизация и тестирование

## Цель

Оптимизировать запросы к БД, добавить индексы и провести финальное тестирование системы статистики.

## Задачи

### 1. Добавление индексов в БД

**Файл: `database/models.py`**

Добавить индексы для оптимизации запросов:

```python
from sqlalchemy import Index

# В модели User
__table_args__ = (
    Index('idx_user_traffic_source', 'traffic_source'),
    Index('idx_user_traffic_campaign', 'traffic_campaign'),
    Index('idx_user_created_at', 'created_at'),
    Index('idx_user_first_deposit_at', 'first_deposit_at'),
    Index('idx_user_first_application_at', 'first_application_at'),
)

# В модели Transaction
__table_args__ = (
    Index('idx_transaction_user_id', 'user_id'),
    Index('idx_transaction_type', 'type'),
    Index('idx_transaction_created_at', 'created_at'),
    Index('idx_transaction_user_type', 'user_id', 'type'),
)

# В модели Application
__table_args__ = (
    Index('idx_application_user_id', 'user_id'),
    Index('idx_application_status', 'status'),
    Index('idx_application_created_at', 'created_at'),
    Index('idx_application_started_at', 'started_at'),
    Index('idx_application_completed_at', 'completed_at'),
)
```

### 2. Оптимизация запросов

**Файл: `database/queries.py`**

- Использовать `select_related` и `joinedload` для избежания N+1 запросов
- Добавить кэширование для часто используемых запросов
- Оптимизировать сложные запросы с использованием подзапросов

### 3. Создание скрипта миграции

**Файл: `scripts/migrate_add_statistics_indexes.py`** (новый)

```python
import asyncio
from sqlalchemy import text
from database.db import get_session, engine

async def add_indexes():
    """Добавление индексов для оптимизации статистики"""
    async with engine.begin() as conn:
        # Индексы для users
        await conn.execute(text("""
            CREATE INDEX IF NOT EXISTS idx_user_traffic_source 
            ON users(traffic_source)
        """))
        await conn.execute(text("""
            CREATE INDEX IF NOT EXISTS idx_user_traffic_campaign 
            ON users(traffic_campaign)
        """))
        await conn.execute(text("""
            CREATE INDEX IF NOT EXISTS idx_user_created_at 
            ON users(created_at)
        """))
        
        # Индексы для transactions
        await conn.execute(text("""
            CREATE INDEX IF NOT EXISTS idx_transaction_user_id 
            ON transactions(user_id)
        """))
        await conn.execute(text("""
            CREATE INDEX IF NOT EXISTS idx_transaction_type 
            ON transactions(type)
        """))
        await conn.execute(text("""
            CREATE INDEX IF NOT EXISTS idx_transaction_created_at 
            ON transactions(created_at)
        """))
        await conn.execute(text("""
            CREATE INDEX IF NOT EXISTS idx_transaction_user_type 
            ON transactions(user_id, type)
        """))
        
        # Индексы для applications
        await conn.execute(text("""
            CREATE INDEX IF NOT EXISTS idx_application_user_id 
            ON applications(user_id)
        """))
        await conn.execute(text("""
            CREATE INDEX IF NOT EXISTS idx_application_status 
            ON applications(status)
        """))
        await conn.execute(text("""
            CREATE INDEX IF NOT EXISTS idx_application_created_at 
            ON applications(created_at)
        """))
        
        print("Индексы успешно добавлены")

if __name__ == "__main__":
    asyncio.run(add_indexes())
```

### 4. Тестирование производительности

**Файл: `tests/test_statistics_performance.py`** (новый)

```python
import asyncio
import time
from database.db import get_session
from utils.statistics import get_comprehensive_stats
from utils.marketing import get_conversion_funnel, get_ltv_by_source

async def test_statistics_performance():
    """Тестирование производительности запросов статистики"""
    
    # Тест комплексной статистики
    start_time = time.time()
    async for session in get_session():
        stats = await get_comprehensive_stats(session, "30_days")
        await session.commit()
    elapsed = time.time() - start_time
    print(f"Комплексная статистика: {elapsed:.2f} сек")
    
    # Тест конверсии
    start_time = time.time()
    async for session in get_session():
        funnel = await get_conversion_funnel(session)
        await session.commit()
    elapsed = time.time() - start_time
    print(f"Конверсия: {elapsed:.2f} сек")
    
    # Тест LTV
    start_time = time.time()
    async for session in get_session():
        ltv = await get_ltv_by_source(session)
        await session.commit()
    elapsed = time.time() - start_time
    print(f"LTV по источникам: {elapsed:.2f} сек")

if __name__ == "__main__":
    asyncio.run(test_statistics_performance())
```

### 5. Функциональное тестирование

**Файл: `tests/test_statistics.py`** (новый)

```python
import pytest
from database.db import get_session
from utils.statistics import (
    get_financial_stats,
    get_applications_stats,
    get_users_stats,
    StatisticsPeriod
)
from utils.marketing import (
    get_conversion_funnel,
    get_average_ltv,
    get_retention_rate
)

@pytest.mark.asyncio
async def test_financial_stats():
    """Тест финансовой статистики"""
    async for session in get_session():
        stats = await get_financial_stats(session, StatisticsPeriod.LAST_30_DAYS)
        assert 'total_revenue' in stats
        assert 'net_revenue' in stats
        assert stats['total_revenue'] >= 0
        await session.commit()

@pytest.mark.asyncio
async def test_applications_stats():
    """Тест статистики по заявкам"""
    async for session in get_session():
        stats = await get_applications_stats(session, StatisticsPeriod.LAST_30_DAYS)
        assert 'total' in stats
        assert 'by_status' in stats
        assert stats['total'] >= 0
        await session.commit()

@pytest.mark.asyncio
async def test_conversion_funnel():
    """Тест конверсии"""
    async for session in get_session():
        funnel = await get_conversion_funnel(session)
        assert 'visitors' in funnel
        assert 'conversion_rates' in funnel
        assert funnel['visitors'] >= 0
        await session.commit()

@pytest.mark.asyncio
async def test_ltv():
    """Тест LTV"""
    async for session in get_session():
        ltv = await get_average_ltv(session)
        assert isinstance(ltv, (int, float))
        assert ltv >= 0
        await session.commit()

@pytest.mark.asyncio
async def test_retention():
    """Тест retention"""
    async for session in get_session():
        retention = await get_retention_rate(session)
        assert isinstance(retention, dict)
        await session.commit()
```

### 6. Документация

**Файл: `docs/statistics.md`** (новый)

Документация по использованию системы статистики:
- Описание всех показателей
- Примеры использования API
- Руководство по интерпретации данных

## Критерии успеха

1. Все запросы выполняются менее чем за 2 секунды
2. Все тесты проходят успешно
3. Индексы добавлены и работают корректно
4. Документация написана

## Оценка времени

**2-3 часа**
