## Блок 5. Состояния, безопасность и этапы реализации

### FSM-состояния (aiogram)

**UserStates**:  
- `waiting_for_screenshot` — ожидание скриншота от пользователя.  
- `waiting_for_payment_amount` — ожидание ввода суммы пополнения.  

**ModeratorStates**:  
- `moderating_session` — активная сессия модерации.  
- `waiting_for_moderator_photo` — ожидание фото от модератора.  

### Безопасность

1. Проверка ролей (user / moderator / admin) перед доступом к панелям.  
2. Валидация всех пользовательских вводов (суммы, статусы, команды).  
3. Защита от повторного создания заявки при уже активной сессии.  
4. Логирование ключевых действий (создание заявки, списание, решение модератора).  

### Этапы реализации

1. Настройка проекта: структура, `requirements.txt`, базовый `bot.py`.  
2. База данных: модели и инициализация SQLite.  
3. Базовые handlers: `/start`, главное меню, кнопки.  
4. Система баланса: пополнение (заглушка) и списание 250₽.  
5. Система заявок и очереди: создание, расчёт позиции и времени ожидания.  
6. Панель модератора: список заявок, выбор заявки.  
7. Сессии модерации: обмен фотографиями и завершение.  
8. Уведомления: обновления статусов и очереди.  
9. Тестирование всех типичных сценариев пользователя и модератора.  

