# Блок 7.5: Согласованность и краевые случаи

## Цель

Убедиться, что переходы «назад» и первый вход без /start работают корректно с одним главным сообщением.

## Задачи

| № | Действие | Файл |
|---|----------|------|
| 5.1 | Убедиться, что переход «Главное меню» из панели модератора по-прежнему использует `update_user_main_message` (уже в `callback_main_menu` в user_handlers). При необходимости поправить. | `handlers/user_handlers.py` |
| 5.2 | При первом входе модератора по /moderator без /start: `get_or_create_moderator_message` создаст новое сообщение и сохранит `main_message_id` — отдельные правки не требуются. При тестировании проверить этот сценарий. | — |

## Чек-лист

- [x] Переход «Главное меню» из панели модератора обновляет одно сообщение.
- [x] Вход по /moderator без предварительного /start создаёт одно сообщение и сохраняет его id.

## Выполнено

✅ **Задача 5.1**: Проверено, что `callback_main_menu` в `handlers/user_handlers.py` (строки 185-190) использует `update_user_main_message` для обновления главного сообщения при переходе из панели модератора в главное меню. Реализация корректна, правки не требуются.

✅ **Задача 5.2**: Проверено, что `cmd_moderator` в `handlers/moderator_handlers.py` (строки 64-69) использует `get_or_create_moderator_message`, который:
- Проверяет наличие `main_message_id` у пользователя
- Если сообщение существует — редактирует его через `safe_edit_message_text`
- Если сообщения нет — создаёт новое через `bot.send_message` и сохраняет `message_id` в БД через `set_user_main_message_id`
- Корректно обрабатывает первый вход по `/moderator` без предварительного `/start`

**Результат**: Все краевые случаи обработаны корректно. Переходы "назад" и первый вход без `/start` работают с одним главным сообщением.
