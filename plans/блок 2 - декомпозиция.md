# Декомпозиция блока 2: Структура базы данных

## Что реализовано

### 1. Модели SQLAlchemy (`database/models.py`)

- **User**
  - `user_id` (PK, Telegram user_id)
  - `username`, `first_name`, `last_name`
  - `balance` (Float, по умолчанию 0.0)
  - `role` (`user` / `moderator` / `admin`, по умолчанию `user`)
  - `created_at` (DateTime, по умолчанию `datetime.utcnow`)
  - связи: `applications`, `moderation_sessions_as_user`, `moderation_sessions_as_moderator`, `transactions`, `moderator_stats`

- **Application**
  - `id` (PK)
  - `user_id` (FK → `users.user_id`)
  - `status` (`pending` / `moderating` / `completed` / `rejected`)
  - `queue_position` (INTEGER, nullable)
  - `estimated_wait_time` (INTEGER, nullable, в секундах)
  - `moderator_id` (FK → `users.user_id`, nullable)
  - `created_at`, `started_at`, `completed_at` (DateTime)
  - связи: `user`, `moderator` (viewonly), `moderation_session`

- **ModerationSession**
  - `id` (PK)
  - `application_id` (FK → `applications.id`)
  - `user_id` (FK → `users.user_id`)
  - `moderator_id` (FK → `users.user_id`)
  - `user_photo_file_id` (TEXT, nullable)
  - `moderator_photo_file_id` (TEXT, nullable)
  - `status` (`active` / `completed`)
  - `created_at` (DateTime)
  - связи: `application`, `user`, `moderator`

- **Transaction**
  - `id` (PK)
  - `user_id` (FK → `users.user_id`)
  - `amount` (REAL, сумма операции)
  - `type` (`deposit` / `withdrawal`)
  - `description` (TEXT, nullable)
  - `created_at` (DateTime)
  - связь: `user`

- **ModeratorStats**
  - `id` (PK)
  - `moderator_id` (FK → `users.user_id`, `unique=True`)
  - `total_sessions` (INTEGER)
  - `total_time_seconds` (INTEGER)
  - `average_session_time` (REAL)
  - связь: `moderator`
  - `UniqueConstraint` по `moderator_id`

### 2. Инициализация БД (`database/db.py`)

- Используется **SQLite + SQLAlchemy async** через `sqlite+aiosqlite`.
- `DATABASE_URL` строится на основе `DATABASE_PATH` из `config.py`.
- Реализовано:
  - `get_engine()` — ленивое создание `AsyncEngine`.
  - `get_session_maker()` — ленивое создание `async_sessionmaker[AsyncSession]`.
  - `init_db()` — создание всех таблиц (`Base.metadata.create_all`) при старте.
  - `get_session()` — асинхронный генератор `AsyncSession` для использования в хендлерах.

### 3. Базовые запросы (`database/queries.py`)

- `get_or_create_user(...)` — получить пользователя или создать нового.
- `change_balance(...)` — изменить баланс пользователя и записать транзакцию (`deposit` / `withdrawal`).
- `can_create_application(...)` — проверка, может ли пользователь создать заявку (баланс ≥ 250₽ и нет активной заявки).
- `create_application(...)` — создание заявки и моментальное списание `APPLICATION_COST`.
- `get_pending_applications(...)` — список ожидающих заявок (`status = 'pending'`) с сортировкой по очереди и дате.
- `assign_moderator_to_application(...)` — назначение модератора, перевод в `moderating`, установка `started_at`.
- `create_moderation_session(...)` — создание записи сессии модерации для заявки.
- `set_session_user_photo(...)` — сохранение `file_id` скриншота пользователя.
- `set_session_moderator_photo(...)` — сохранение `file_id` фото модератора.
- `complete_moderation_session(...)` — завершение сессии, установка статуса заявки (`completed` / `rejected`) и `completed_at`.
- `get_or_create_moderator_stats(...)` — получение/создание статистики модератора.
- `update_moderator_stats_after_session(...)` — обновление статистики после сессии, пересчёт `average_session_time`.
- `get_average_session_time_global(...)` — среднее время сессии по всем модераторам с fallback на значение по умолчанию.

## Связь с остальными блоками

- Блок 3 будет использовать модели и функции из `queries.py` для:
  - регистрации/получения пользователя,
  - создания заявок,
  - назначения модераторов,
  - работы с балансом и транзакциями.
- Блок 4 будет опираться на `ModeratorStats` и `get_average_session_time_global` для расчёта времени ожидания.

