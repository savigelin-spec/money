# –ë–ª–æ–∫ 6.5: UI –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## –¶–µ–ª—å

–°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞.

## –ó–∞–¥–∞—á–∏

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–§–∞–π–ª: `handlers/admin_statistics_handlers.py`** (–Ω–æ–≤—ã–π)

```python
from aiogram import Router, F
from aiogram.types import CallbackQuery
from aiogram.fsm.context import FSMContext
from database.db import get_session
from utils.statistics import (
    get_comprehensive_stats,
    get_financial_stats,
    get_applications_stats,
    get_users_stats,
    get_traffic_stats,
    StatisticsPeriod,
    format_stars,
    format_time,
    format_percentage
)
from utils.marketing import (
    get_conversion_funnel,
    get_conversion_by_source,
    get_average_ltv,
    get_ltv_by_source,
    get_retention_rate
)
from keyboards.admin_keyboards import (
    get_statistics_main_keyboard,
    get_statistics_period_keyboard,
    get_statistics_type_keyboard,
    get_traffic_sources_keyboard
)
from utils.security import check_admin_access

router = Router()

@router.callback_query(F.data == "admin_statistics")
async def callback_admin_statistics(callback: CallbackQuery):
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    if not await check_admin_access(callback):
        return
    
    text = (
        "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
    )
    
    await callback.message.edit_text(
        text,
        reply_markup=get_statistics_main_keyboard()
    )
    await callback.answer()

@router.callback_query(F.data.startswith("stats_period_"))
async def callback_stats_period(callback: CallbackQuery):
    """–í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    if not await check_admin_access(callback):
        return
    
    period = callback.data.split("_")[-1]
    
    async for session in get_session():
        stats = await get_comprehensive_stats(session, period)
        await session.commit()
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    text = format_comprehensive_stats(stats)
    
    await callback.message.edit_text(
        text,
        reply_markup=get_statistics_period_keyboard()
    )
    await callback.answer()

@router.callback_query(F.data.startswith("stats_type_"))
async def callback_stats_type(callback: CallbackQuery):
    """–í—ã–±–æ—Ä —Ç–∏–ø–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    if not await check_admin_access(callback):
        return
    
    stats_type = callback.data.split("_")[-1]
    period = StatisticsPeriod.LAST_30_DAYS  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    async for session in get_session():
        if stats_type == "financial":
            stats = await get_financial_stats(session, period)
            text = format_financial_stats(stats)
        elif stats_type == "applications":
            stats = await get_applications_stats(session, period)
            text = format_applications_stats(stats)
        elif stats_type == "users":
            stats = await get_users_stats(session, period)
            text = format_users_stats(stats)
        elif stats_type == "marketing":
            funnel = await get_conversion_funnel(session)
            ltv = await get_average_ltv(session)
            retention = await get_retention_rate(session)
            text = format_marketing_stats(funnel, ltv, retention)
        elif stats_type == "traffic":
            stats = await get_traffic_stats(session, period)
            text = format_traffic_stats(stats)
        else:
            text = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
        
        await session.commit()
    
    await callback.message.edit_text(
        text,
        reply_markup=get_statistics_type_keyboard()
    )
    await callback.answer()
```

### 2. –§—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª: `utils/statistics.py`**

```python
def format_stars(amount: int) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥"""
    return f"{amount:,}‚≠ê"

def format_time(seconds: int) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –≤ —á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç"""
    if seconds < 60:
        return f"{seconds} —Å–µ–∫"
    elif seconds < 3600:
        return f"{seconds // 60} –º–∏–Ω {seconds % 60} —Å–µ–∫"
    else:
        hours = seconds // 3600
        minutes = (seconds % 3600) // 60
        return f"{hours} —á {minutes} –º–∏–Ω"

def format_percentage(value: float) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç"""
    return f"{value:.1f}%"

def format_financial_stats(stats: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    text = (
        f"üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ({stats.get('period', '–ø–µ—Ä–∏–æ–¥')})\n\n"
        f"üì• –ü–æ–ª—É—á–µ–Ω–æ –∑–≤—ë–∑–¥: {format_stars(stats.get('total_revenue', 0))}\n"
        f"üì§ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –∑–≤—ë–∑–¥: {format_stars(stats.get('total_withdrawals', 0))}\n"
        f"üíµ –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å: {format_stars(stats.get('net_revenue', 0))}\n"
        f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ–ø–æ–∑–∏—Ç–æ–≤: {stats.get('total_deposits', 0)}"
    )
    return text

def format_applications_stats(stats: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∑–∞—è–≤–∫–∞–º"""
    by_status = stats.get('by_status', {})
    text = (
        f"üìã –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞—è–≤–∫–∞–º ({stats.get('period', '–ø–µ—Ä–∏–æ–¥')})\n\n"
        f"–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: {stats.get('total', 0)}\n"
        f"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: {by_status.get('completed', 0)} ({format_percentage(stats.get('success_rate', 0))})\n"
        f"‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ: {by_status.get('rejected', 0)}\n"
        f"‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ: {by_status.get('moderating', 0) + by_status.get('pending', 0)}\n\n"
        f"‚è± –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {format_time(int(stats.get('average_processing_time', 0)))}\n"
        f"‚è≥ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤ –æ—á–µ—Ä–µ–¥–∏: {format_time(int(stats.get('average_queue_time', 0)))}\n"
    )
    return text

def format_users_stats(stats: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
    by_role = stats.get('by_role', {})
    text = (
        f"üë• –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º ({stats.get('period', '–ø–µ—Ä–∏–æ–¥')})\n\n"
        f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats.get('total', 0)}\n"
        f"üü¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö: {stats.get('active', 0)}\n\n"
        f"üìä –ü–æ —Ä–æ–ª—è–º:\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: {by_role.get('user', 0)}\n"
        f"üëÆ –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã: {by_role.get('moderator', 0)}\n"
        f"üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã: {by_role.get('admin', 0)}\n"
    )
    return text

def format_marketing_stats(funnel: dict, ltv: float, retention: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    conversion_rates = funnel.get('conversion_rates', {})
    text = (
        f"üìà –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏\n\n"
        f"üéØ –ö–æ–Ω–≤–µ—Ä—Å–∏—è:\n"
        f"–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏: {funnel.get('visitors', 0)}\n"
        f"‚Üí –ü–µ—Ä–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç: {funnel.get('first_deposit', 0)} ({format_percentage(conversion_rates.get('to_deposit', 0))})\n"
        f"‚Üí –ü–µ—Ä–≤–∞—è –∑–∞—è–≤–∫–∞: {funnel.get('first_application', 0)} ({format_percentage(conversion_rates.get('to_application', 0))})\n"
        f"‚Üí –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏: {funnel.get('completed_application', 0)} ({format_percentage(conversion_rates.get('to_completed', 0))})\n\n"
        f"üí∞ LTV (Lifetime Value):\n"
        f"–°—Ä–µ–¥–Ω–∏–π LTV: {format_stars(int(ltv))}\n\n"
        f"üîÑ Retention:\n"
    )
    
    for key, value in retention.items():
        day = key.replace('day_', '')
        text += f"–î–µ–Ω—å {day}: {format_percentage(value)}\n"
    
    return text

def format_traffic_stats(stats: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º —Ç—Ä–∞—Ñ–∏–∫–∞"""
    top_by_revenue = stats.get('top_by_revenue', [])
    top_by_users = stats.get('top_by_users', [])
    top_by_conversion = stats.get('top_by_conversion', [])
    
    text = (
        f"üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ ({stats.get('period', '–ø–µ—Ä–∏–æ–¥')})\n\n"
        f"üí∞ –¢–æ–ø –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ –¥–æ—Ö–æ–¥—É:\n"
    )
    
    for i, source_data in enumerate(top_by_revenue[:5], 1):
        text += (
            f"{i}. {source_data.get('source', 'unknown')} - "
            f"{format_stars(source_data.get('revenue', 0))}\n"
        )
    
    text += f"\nüìä –¢–æ–ø –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:\n"
    for i, source_data in enumerate(top_by_users[:5], 1):
        text += (
            f"{i}. {source_data.get('source', 'unknown')} - "
            f"{source_data.get('users', 0)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n"
        )
    
    text += f"\nüéØ –¢–æ–ø –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏:\n"
    for i, source_data in enumerate(top_by_conversion[:5], 1):
        text += (
            f"{i}. {source_data.get('source', 'unknown')} - "
            f"{format_percentage(source_data.get('conversion_rate', 0))}\n"
        )
    
    return text

def format_comprehensive_stats(stats: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    financial = stats.get('financial', {})
    applications = stats.get('applications', {})
    users = stats.get('users', {})
    
    text = (
        f"üìä –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ({stats.get('period', '–ø–µ—Ä–∏–æ–¥')})\n\n"
        f"üí∞ –§–∏–Ω–∞–Ω—Å—ã:\n"
        f"–î–æ—Ö–æ–¥: {format_stars(financial.get('total_revenue', 0))}\n"
        f"–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å: {format_stars(financial.get('net_revenue', 0))}\n\n"
        f"üìã –ó–∞—è–≤–∫–∏:\n"
        f"–í—Å–µ–≥–æ: {applications.get('total', 0)}\n"
        f"–£—Å–ø–µ—à–Ω—ã—Ö: {format_percentage(applications.get('success_rate', 0))}\n\n"
        f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\n"
        f"–í—Å–µ–≥–æ: {users.get('total', 0)}\n"
        f"–ê–∫—Ç–∏–≤–Ω—ã—Ö: {users.get('active', 0)}\n"
    )
    return text
```

### 3. –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã

**–§–∞–π–ª: `keyboards/admin_keyboards.py`**

```python
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

def get_statistics_main_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(
                text="üí∞ –ë–∏–∑–Ω–µ—Å-–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏",
                callback_data="stats_type_financial"
            )
        ],
        [
            InlineKeyboardButton(
                text="üìà –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥",
                callback_data="stats_type_marketing"
            )
        ],
        [
            InlineKeyboardButton(
                text="üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞",
                callback_data="stats_type_traffic"
            )
        ],
        [
            InlineKeyboardButton(
                text="üìã –í—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏",
                callback_data="stats_type_comprehensive"
            )
        ],
        [
            InlineKeyboardButton(
                text="‚óÄÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",
                callback_data="admin_panel"
            )
        ]
    ])
    return keyboard

def get_statistics_period_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="–°–µ–≥–æ–¥–Ω—è", callback_data="stats_period_today"),
            InlineKeyboardButton(text="7 –¥–Ω–µ–π", callback_data="stats_period_7_days")
        ],
        [
            InlineKeyboardButton(text="30 –¥–Ω–µ–π", callback_data="stats_period_30_days"),
            InlineKeyboardButton(text="–í—Å—ë –≤—Ä–µ–º—è", callback_data="stats_period_all_time")
        ],
        [
            InlineKeyboardButton(
                text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
                callback_data="admin_statistics"
            )
        ]
    ])
    return keyboard

def get_statistics_type_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(
                text="üí∞ –§–∏–Ω–∞–Ω—Å—ã",
                callback_data="stats_type_financial"
            ),
            InlineKeyboardButton(
                text="üìã –ó–∞—è–≤–∫–∏",
                callback_data="stats_type_applications"
            )
        ],
        [
            InlineKeyboardButton(
                text="üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
                callback_data="stats_type_users"
            ),
            InlineKeyboardButton(
                text="üìà –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥",
                callback_data="stats_type_marketing"
            )
        ],
        [
            InlineKeyboardButton(
                text="üîó –¢—Ä–∞—Ñ–∏–∫",
                callback_data="stats_type_traffic"
            )
        ],
        [
            InlineKeyboardButton(
                text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
                callback_data="admin_statistics"
            )
        ]
    ])
    return keyboard
```

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

**–§–∞–π–ª: `handlers/admin_handlers.py`**

–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.

**–§–∞–π–ª: `bot.py`**

–ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–æ—É—Ç–µ—Ä:
```python
from handlers import admin_statistics_handlers

dp.include_router(admin_statistics_handlers.router)
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –º–µ–Ω—é
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

## –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏

**4-5 —á–∞—Å–æ–≤**
