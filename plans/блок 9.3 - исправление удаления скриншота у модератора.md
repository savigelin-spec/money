# Блок 9.3: Исправление удаления скриншота у модератора

## Цель

Исправить функцию `delete_moderator_screenshot_message_for_application` так, чтобы сообщение «Скриншот от пользователя» в чате модератора действительно удалялось после approve/reject.

## Причина бага

В `utils/moderator_messages.py` в `delete_moderator_screenshot_message_for_application`:

- Сразу после загрузки сессии вызывается `await session.commit()` — в SQLAlchemy после commit объекты помечаются как expired, что может мешать чтению `mod_session.moderator_id` и `mod_session.moderator_screenshot_message_id`.
- Используются два цикла `async for session in get_session()`: один для загрузки и удаления в Telegram, второй для обнуления поля в БД. Надёжнее вести логику в одной сессии.

## Задачи

| № | Действие | Файл |
|---|----------|------|
| 3.1 | Убрать `await session.commit()` сразу после загрузки `mod_session` | `utils/moderator_messages.py` |
| 3.2 | Прочитать `moderator_id` и `msg_id` в локальные переменные сразу после проверки `if not mod_session or not mod_session.moderator_screenshot_message_id` | `utils/moderator_messages.py` |
| 3.3 | Удалить сообщение в Telegram, в той же сессии обнулить `mod_session.moderator_screenshot_message_id`, один раз вызвать `await session.commit()` | `utils/moderator_messages.py` |
| 3.4 | Убрать второй цикл `async for session in get_session()` для обнуления — делать всё в одном цикле | `utils/moderator_messages.py` |

## Пример исправленной логики

```python
async for session in get_session():
    mod_session = await get_moderation_session_by_application_id(session, application_id)
    if not mod_session or not mod_session.moderator_screenshot_message_id:
        return
    moderator_id = mod_session.moderator_id
    msg_id = mod_session.moderator_screenshot_message_id
    try:
        await bot.delete_message(chat_id=moderator_id, message_id=msg_id)
        ...
    except TelegramBadRequest as e:
        ...
    mod_session.moderator_screenshot_message_id = None
    await session.commit()
```

## Чек-лист

- [x] Одна сессия БД на весь сценарий
- [x] Нет commit до чтения полей
- [x] Сообщение со скриншотом удаляется у модератора при approve/reject

## Выполнено

✅ **Задача 3.1**: Убран `await session.commit()` сразу после загрузки `mod_session` - теперь commit выполняется только один раз в конце функции.

✅ **Задача 3.2**: Поля `moderator_id` и `msg_id` читаются в локальные переменные сразу после проверки `if not mod_session or not mod_session.moderator_screenshot_message_id`, до любых операций с БД.

✅ **Задача 3.3**: Удаление сообщения в Telegram выполняется, затем в той же сессии обнуляется `mod_session.moderator_screenshot_message_id` и вызывается один `await session.commit()` в конце.

✅ **Задача 3.4**: Убран второй цикл `async for session in get_session()` - вся логика выполняется в одном цикле с одной сессией БД.

Теперь функция `delete_moderator_screenshot_message_for_application` работает корректно: использует одну сессию БД, читает поля до commit, и сообщение со скриншотом успешно удаляется у модератора при approve/reject.
