# Декомпозиция блока 5: Состояния, безопасность и этапы реализации

## FSM состояния

### Реализовано в `handlers/states.py`

- **UserStates**:
  - `waiting_for_screenshot` — ожидание скриншота от пользователя
  - `waiting_for_payment_amount` — ожидание суммы пополнения баланса

- **ModeratorStates**:
  - `moderating_session` — активная сессия модерации
  - `waiting_for_moderator_photo` — ожидание фото от модератора

Все состояния используются в соответствующих handlers для управления потоком взаимодействия.

## Безопасность

### 1. Проверка ролей (`utils/security.py`)

Реализованы централизованные функции проверки доступа:

- **`check_role_access(user, required_roles)`** — универсальная проверка доступа по ролям
- **`is_moderator_or_admin(user)`** — проверка прав модератора/админа
- **`is_admin_only(user)`** — проверка прав администратора

Используется в:
- `handlers/moderator_handlers.py` — проверка доступа к панели модератора
- `handlers/admin_handlers.py` — проверка доступа к админским командам

### 2. Валидация пользовательских вводов (`utils/security.py`)

- **`validate_amount(amount, min_amount, max_amount)`** — валидация суммы платежа
  - Проверка минимальной/максимальной суммы
  - Проверка на положительное число
  
- **`validate_user_id(user_id_str)`** — валидация user_id из строки
  - Проверка формата (должно быть число)
  - Проверка на положительное значение
  
- **`validate_role(role)`** — валидация роли пользователя
  - Проверка соответствия допустимым ролям (user, moderator, admin)

Используется в:
- `handlers/user_handlers.py` — валидация суммы пополнения
- `handlers/admin_handlers.py` — валидация команд администратора

### 3. Защита от повторного создания заявки

Реализовано в `database/queries.py` через функцию `can_create_application()`:

- Проверка баланса (минимум APPLICATION_COST)
- Проверка отсутствия активных заявок (status = "pending" или "moderating")

Используется в `handlers/user_handlers.py` перед созданием заявки.

### 4. Логирование ключевых действий

Добавлено логирование через стандартный модуль `logging`:

**В `handlers/user_handlers.py`:**
- Создание заявки: логируется user_id, application_id, баланс после списания
- Пополнение баланса: логируется user_id, сумма, новый баланс, transaction_id

**В `handlers/moderator_handlers.py`:**
- Взятие заявки модератором: логируется moderator_id, application_id, user_id
- Подтверждение заявки: логируется moderator_id, application_id, user_id, длительность сессии
- Отклонение заявки: логируется moderator_id, application_id, user_id, длительность сессии

**В `handlers/admin_handlers.py`:**
- Изменение роли пользователя: логируется admin_id, target_user_id, старая и новая роль
- Назначение модератора: логируется admin_id, target_user_id
- Удаление роли модератора: логируется admin_id, target_user_id

Все логи записываются с уровнем INFO или ERROR для ошибок.

## Админские команды (`handlers/admin_handlers.py`)

Реализованы команды для управления системой:

- **`/admin`** — показ панели администратора со списком доступных команд

- **`/set_role <user_id> <role>`** — назначение роли пользователю
  - Валидация user_id и роли
  - Логирование изменения
  - Подтверждение администратору

- **`/set_moderator <user_id>`** — быстрая команда для назначения модератора
  - Упрощённый вариант `/set_role` для модераторов

- **`/remove_moderator <user_id>`** — убрать роль модератора
  - Проверка, что пользователь действительно модератор
  - Установка роли "user"

- **`/user_info <user_id>`** — информация о пользователе
  - Показывает: имя, username, роль, баланс, количество заявок, дату регистрации

- **`/list_users`** — список последних 20 пользователей
  - Показывает: user_id, username, роль, баланс

Все команды защищены проверкой прав администратора через `check_admin_access()`.

## Этапы реализации (статус)

1. ✅ **Настройка проекта**: структура, `requirements.txt`, базовый `bot.py`
2. ✅ **База данных**: модели и инициализация SQLite
3. ✅ **Базовые handlers**: `/start`, главное меню, кнопки
4. ✅ **Система баланса**: пополнение (тестовый режим) и списание 250₽
5. ✅ **Система заявок и очереди**: создание, расчёт позиции и времени ожидания
6. ✅ **Панель модератора**: список заявок, выбор заявки
7. ✅ **Сессии модерации**: обмен фотографиями и завершение
8. ✅ **Уведомления**: обновления статусов и очереди
9. ⏳ **Тестирование**: требуется ручное тестирование всех сценариев

## Интеграция

- Все routers зарегистрированы в `bot.py`:
  - `user_handlers.router`
  - `moderator_handlers.router`
  - `admin_handlers.router` (новый)

- Утилиты безопасности используются во всех handlers для консистентной проверки доступа

- Логирование настроено на уровне INFO для отслеживания ключевых действий

## Дополнительные улучшения безопасности

- Все команды администратора проверяют права доступа перед выполнением
- Валидация всех пользовательских вводов (суммы, user_id, роли)
- Защита от SQL-инъекций через использование параметризованных запросов SQLAlchemy
- Защита от повторного создания заявки при активной сессии
- Логирование всех критических операций для аудита

## Готовность к продакшену

Система готова к тестированию. Для продакшена рекомендуется:

1. Настроить переменные окружения для токена бота
2. Настроить логирование в файл (опционально)
3. Добавить rate limiting для защиты от спама
4. Интегрировать реальное API платёжной системы
5. Настроить мониторинг и алерты
6. Провести полное тестирование всех сценариев
