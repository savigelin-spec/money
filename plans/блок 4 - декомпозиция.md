# Декомпозиция блока 4: Очередь и баланс

## Очередь и время ожидания

### Реализовано в `utils/queue.py`

- **`calculate_queue_position(session, application_id)`**
  - Считает позицию заявки в очереди среди всех `pending` заявок.
  - Позиция определяется по порядку создания заявок.

- **`calculate_estimated_wait_time(session, queue_position)`**
  - Считает примерное время ожидания по формуле  
    \`ожидание = (позиция_в_очереди - 1) × среднее_время_сессии\`.
  - Среднее время берётся из `ModeratorStats` через `get_average_session_time_global`,
    при отсутствии статистики используется `DEFAULT_MODERATOR_SESSION_TIME` из `config.py`.

- **`update_queue_positions(session)`**
  - Обновляет `queue_position` и `estimated_wait_time` для всех `pending` заявок.
  - Вызывается после создания заявки и после взятия заявки модератором в работу.

- **`format_wait_time(seconds)`**
  - Преобразует секунды ожидания в человекочитаемый формат:
    - `< 60` — секунды,
    - `< 3600` — минуты,
    - `≥ 3600` — часы и минуты.

## Баланс и тестовые платежи

### Утилиты баланса (`utils/balance.py`)

- **`get_balance(session, user_id)`**
  - Возвращает текущий баланс пользователя.

- **`test_deposit(session, user_id, amount, transaction_id)`**
  - Тестовое пополнение баланса без реального платёжного API.
  - Использует общую функцию `change_balance` из `database.queries`.
  - Формирует описание транзакции вида  
    `Тестовое пополнение баланса на X₽ | ID транзакции: ...`.
  - Возвращает обновлённый баланс пользователя.

### Изменения в `handlers/user_handlers.py`

- **Пополнение баланса (`callback_deposit_balance` + `process_payment_amount`)**
  - Пользователь нажимает кнопку «Пополнить баланс».
  - Бот переводит его в состояние `UserStates.waiting_for_payment_amount`.
  - Пользователь вводит сумму (валидация по regexp и минимальная сумма 100₽).
  - В `process_payment_amount`:
    - Формируется тестовый `transaction_id` вида `TEST_userId_timestamp`.
    - Вызывается `test_deposit`, баланс обновляется сразу.
    - Создаётся запись транзакции через `change_balance`.
    - Пользователь видит:
      - сумму пополнения,
      - ID транзакции,
      - новый баланс,
      - явное предупреждение, что это **тестовый режим**, а реальные списания пока не выполняются.

- **Проверка баланса и списание**
  - Проверка достаточного баланса и отсутствия активной заявки — через `can_create_application`.
  - Списание 250₽ при создании заявки реализовано в `create_application` (`database.queries`),
    и уже используется в `callback_create_application`.

## Связь с другими блоками

- **Блок 2 (БД)** — используются:
  - таблицы `transactions`, `moderator_stats`,
  - функции `change_balance`, `get_average_session_time_global`.

- **Блок 3 (логика пользователей и модераторов)** — очередь и баланс интегрированы в:
  - создание заявок (`callback_create_application`),
  - просмотр и обновление статуса заявок,
  - панель модератора (обновление очереди при взятии заявки).

## Текущее состояние

- Логика очереди и расчёта примерного времени ожидания **реализована и используется**.
- Списание 250₽ при создании заявки **реализовано**.
- Пополнение баланса работает в **тестовом режиме**:
  - баланс меняется в БД,
  - транзакции записываются,
  - никакая реальная платёжная система не вызывается.
- Подключение реального API платёжки можно будет реализовать позже,
  заменив реализацию `test_deposit` и/или обработчик `process_payment_amount`.

