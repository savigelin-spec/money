# План: лайв-чат пользователь–модератор и завершение сессии

## Важное правило завершения сессии

**Модератор не может завершить сессию по своей инициативе.** Возможны только два способа завершения:

1. **Пользователь сам завершает сессию** — кнопка «Завершить сессию» у пользователя.
2. **Неактивность пользователя ≥ 3 минут** — после этого модератору показывается кнопка «Завершить сессию (неактивность)», и только тогда модератор может завершить сессию.

Кнопки «Подтвердить»/«Отклонить» у модератора остаются для решения по заявке (approve/reject) и при нажатии тоже завершают сессию и запускают очистку сообщений.

---

## Текущее состояние (как сейчас проходит сессия)

- **Создание сессии:** модератор берёт заявку → создаётся ModerationSession (status=`active`), пользователю обновляется информационное сообщение («Отправьте скриншот»).
- **Обмен:** только фото: пользователь отправляет скриншот → бот пересылает модератору; модератор отправляет фото → бот пересылает пользователю с кнопкой «Подтвердить».
- **Завершение:** только модератор — кнопки «Подтвердить»/«Отклонить» → complete_moderation_session.
- **Удаление после завершения:** при approve/reject удаляются уведомления модераторов, сообщение со скриншотом и с фото модератора в чатах модератора; у пользователя при «Подтвердить» удаляются сообщение с фото модератора и информационное сообщение.

Текстового чата между пользователем и модератором сейчас нет.

---

## Целевое поведение

1. **Лайв-чат:** во время активной сессии сообщения (текст, фото) пересылаются между пользователем и модератором; все сообщения бота сохраняются для удаления при завершении.
2. **Завершение сессии (строго):**
   - **Пользователь** нажимает «Завершить сессию» → сессия завершается; или
   - **Неактивность пользователя ≥ 3 мин** → у модератора появляется кнопка «Завершить сессию (неактивность)», модератор нажимает → сессия завершается; или
   - **Модератор** нажимает «Подтвердить»/«Отклонить» по заявке → сессия завершается (как сейчас).
   - Модератор **не** имеет отдельной кнопки «Завершить сессию» без условия неактивности.
3. **После завершения:** у пользователя и у модератора удаляются все сообщения сессии (по аналогии с текущей реализацией).

---

## Изменения по слоям

### 1. Модель данных и БД

- Таблица или структура для хранения message_id сообщений лайв-чата (например, `moderation_session_messages`: session_id, chat_id, message_id).
- В ModerationSession поле `last_user_activity_at` (DateTime) — обновлять при каждом сообщении от пользователя.

### 2. Лайв-чат

- Обработчики пересылки текста/фото от пользователя к модератору и от модератора к пользователю; сохранение message_id отправленных ботом сообщений; обновление `last_user_activity_at` при действиях пользователя.

### 3. Завершение сессии

- **У пользователя:** кнопка «Завершить сессию» (callback `user_end_session_{session_id}`) — всегда доступна при активной сессии.
- **У модератора:** кнопка «Завершить сессию (неактивность)» показывается **только** если `last_user_activity_at` старше 3 минут; callback `moderator_end_session_inactive_{session_id}`. Отдельной кнопки «Завершить сессию» без проверки неактивности не делать.

### 4. Единая очистка сообщений

- Одна функция очистки по session_id (все сообщения из moderation_session_messages + поля ModerationSession). Вызывать при любом завершении: user_end_session, moderator_end_session_inactive, approve, reject.

---

## Итог по правилу

- Модератор завершает сессию **только** в двух случаях: нажатие «Подтвердить»/«Отклонить» (решение по заявке) или нажатие «Завершить сессию (неактивность)» при неактивности пользователя ≥ 3 мин.
- Пользователь может завершить сессию в любой момент кнопкой «Завершить сессию».
