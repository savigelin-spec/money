---
name: Маркетинговая вкладка Подробная статистика
overview: "Пересборка вкладки «Маркетинг» в админ-статистике: вывод блоков «Финансовые метрики» (LTV, ARPU, ARPPU), «Конверсии» (Регистрация → Оплата), «Пользователи» (Всего, Платящих, Конверсия) и кнопок «Обновить» / «Назад» по макету со скриншота."
todos: []
isProject: false
---

# План: интеграция данных со скриншота во вкладку «Маркетинговые показатели»

## Целевой вид экрана (по скриншоту)

- **Заголовок:** «Подробная статистика»
- **Финансовые метрики:** LTV (на платящего), ARPU (на всех), ARPPU (на платящего) — в валюте (Р на скриншоте)
- **Конверсии:** Регистрация → Оплата: X%
- **Пользователи:** Всего, Платящих, Конверсия: X%
- **Кнопки:** «Обновить», «Назад»

Текущая реализация маркетинга (`[handlers/admin_statistics_handlers.py](handlers/admin_statistics_handlers.py)` 182–186) показывает воронку (посетители → депозит → заявка → завершённые), один LTV и блок retention. Нужно заменить контент и клавиатуру на вариант со скриншота.

---

## 1. Слой данных

**Новые/используемые метрики:**


| Метрика                    | Расчёт                                                                                             |
| -------------------------- | -------------------------------------------------------------------------------------------------- |
| Всего пользователей        | `get_total_users(session, start, end)`                                                             |
| Платящих                   | Число уникальных `user_id` с хотя бы одной транзакцией-депозитом за период                         |
| Общая выручка              | `get_total_revenue(session, start, end)` (уже есть в `[database/queries.py](database/queries.py)`) |
| Конверсия Рег→Оплата       | (Платящих / Всего) × 100                                                                           |
| LTV (на платящего) = ARPPU | Выручка / Платящих                                                                                 |
| ARPU (на всех)             | Выручка / Всего                                                                                    |


**Изменения в коде:**

- `**[database/queries.py](database/queries.py)**`  
Добавить функцию `**get_paying_users(session, start_date=None, end_date=None) -> int**`: подсчёт `COUNT(DISTINCT user_id)` по `Transaction` с `type == TRANSACTION_DEPOSIT` и фильтром по дате транзакции (аналогично `_transaction_date_filter`). Так «платящие» — те, кто совершил хотя бы один депозит в выбранном периоде.
- **Агрегат для экрана**  
Либо в `**[utils/marketing.py](utils/marketing.py)**` добавить `**get_detailed_marketing_stats(session, start_date=None, end_date=None) -> dict**`, который вызывает:
  - `get_total_users`
  - `get_paying_users` (новая)
  - `get_total_revenue`
  и возвращает словарь: `total_users`, `paying_users`, `total_revenue`, `conversion_pct`, `ltv_per_payer` (ARPPU), `arpu`.  
  Либо эту агрегацию можно сделать в `[utils/statistics.py](utils/statistics.py)`, если хочется держать всё в одном модуле статистики. Оба варианта допустимы; в плане заложен вариант в `utils/marketing.py` как «маркетинговые» метрики.
- **Период:** на скриншоте период не выбран. Имеет смысл по умолчанию считать **всё время** (`start_date=None`, `end_date=None`). При желании позже можно добавить выбор периода так же, как у «Финансы».

---

## 2. Форматирование текста

- `**[utils/statistics.py](utils/statistics.py)**`  
Ввести `**format_detailed_marketing_stats(data: dict) -> str**`, формирующий один блок текста:
  - заголовок «Подробная статистика» (или «Маркетинговые показатели» — по желанию);
  - блок «Финансовые метрики» с тремя строками: LTV (на платящего), ARPU (на всех), ARPPU (на платящего);
  - блок «Конверсии»: одна строка «Регистрация → Оплата: X%»;
  - блок «Пользователи»: Всего, Платящих, Конверсия: X%.
  Валюта: в проекте сейчас используется `[format_stars](utils/statistics.py)` (звёзды). На скриншоте — «Р». Либо ввести отдельный форматтер для этого экрана (например `123.45Р`), либо использовать существующий — указать в плане, что при необходимости легко заменить вывод на «Р».
  Учесть деление на ноль: при 0 пользователей или 0 платящих подставлять 0 для ARPU/ARPPU и конверсии.

---

## 3. Клавиатура и обработчики

- `**[keyboards/admin_keyboards.py](keyboards/admin_keyboards.py)**`  
Добавить `**get_marketing_detail_keyboard()**`: одна строка кнопок:
  - «Обновить» → `callback_data="stats_marketing_refresh"`;
  - «Назад» → `callback_data="admin_statistics"` (возврат в меню «Статистика бота»).
- `**[handlers/admin_statistics_handlers.py](handlers/admin_statistics_handlers.py)**`  
  - В `**callback_stats_type**` для `stats_type == "marketing"`:
    - вызывать `get_detailed_marketing_stats(session)` (вместо funnel/ltv/retention);
    - формировать текст через `format_detailed_marketing_stats(data)`;
    - клавиатура — `get_marketing_detail_keyboard()` вместо `get_statistics_type_keyboard()`.
  - Добавить обработчик `**callback_stats_marketing_refresh**` по `F.data == "stats_marketing_refresh"`: снова запрос `get_detailed_marketing_stats`, `format_detailed_marketing_stats`, обновление того же сообщения и та же клавиатура `get_marketing_detail_keyboard()`.

Импорты в хендлере: новая функция агрегата из `utils.marketing`, новая функция форматирования и новая клавиатура из `keyboards.admin_keyboards`.

---

## 4. Что можно не трогать / опционально

- `**format_marketing_stats**` в `utils/statistics.py` (старый текст с воронкой и retention) — можно оставить для возможного использования в других местах или удалить, если нигде не используется.
- `**get_conversion_funnel**`, `**get_average_ltv**`, `**get_retention_rate**` в маркетинговом экране больше не вызывать; при необходимости оставить их для других отчётов.
- Период для маркетинга: сейчас не добавляем выбор периода; при желании позже можно сохранять в FSM выбранный период и передавать его в `get_detailed_marketing_stats` и добавить клавиатуру выбора периода по аналогии с финансами.

---

## Порядок внедрения

1. **database/queries.py** — реализовать `get_paying_users`.
2. **utils/marketing.py** — реализовать `get_detailed_marketing_stats`.
3. **utils/statistics.py** — реализовать `format_detailed_marketing_stats` (и при необходимости формат вывода «Р»).
4. **keyboards/admin_keyboards.py** — добавить `get_marketing_detail_keyboard`.
5. **handlers/admin_statistics_handlers.py** — переключить маркетинг на новые данные и клавиатуру, добавить `stats_marketing_refresh`.

После этого вкладка «Маркетинг» будет показывать блоки и кнопки в соответствии со скриншотом «Подробная статистика».